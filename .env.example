# ==============================================================================
# Meilisearch4TelegramSearchCKJ 配置文件示例
#
# 使用说明:
#   1. 复制此文件为 .env: cp .env.example .env
#   2. 修改下方配置项为你的实际值
#   3. 启动服务: python -m tg_search 或 docker-compose up
#
# 注意:
#   - 所有 "必填" 标记的配置项必须设置
#   - 列表类型使用 Python 语法: [1, 2, 3] 或 []
#   - 布尔类型使用 Python 语法: True 或 False
# ==============================================================================
# ⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️
# ⚠️⚠️⚠️注意数据安全！公网部署API_KEY必须设置⚠️⚠️⚠️
# ⚠️⚠️⚠️ 注意数据安全！OWNER_IDS必须设置  ⚠️⚠️⚠️
# ⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️

# ==============================================================================
# Telegram API 设置 (必填)
# ==============================================================================

# Telegram API ID (从 https://my.telegram.org/apps 获取)
APP_ID=23010002

# Telegram API Hash (从 https://my.telegram.org/apps 获取)
APP_HASH=d1f1d1f1d1f1d1f1d1f1d1f1d1f1d1f1

# Telegram Bot Token (从 @BotFather 获取)
BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11


# ==============================================================================
# MeiliSearch 设置 (必填)
# ==============================================================================

# MeiliSearch 服务器地址
# 本地部署: http://localhost:7700
# Docker 部署: http://meilisearch:7700
# HuggingFace Spaces: https://username-spacename.hf.space
MEILI_HOST=https://username-spacename.hf.space

# MeiliSearch 主密钥 (用于认证)
MEILI_MASTER_KEY=eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee

# 运行时配置与会话状态 SQLite 路径（默认: session/config_store.sqlite3）
# 包含：
# - system_config: ai/storage/policy/sync.available_cache_ttl_sec
# - dialog_state: sync_state/date_from/last_synced_at/latest_msg_id
# 生产环境建议挂载持久卷，避免容器重建后丢失运行时配置
# CONFIG_DB_PATH=session/config_store.sqlite3


# ==============================================================================
# Bot 访问控制 (可选)
# ==============================================================================

# ⚠️ 警告：策略服务冷启动默认值 (WHITE_LIST)
# 仅在 SQLite ConfigStore 未初始化（即首次部署启动）时有效！
# 如果系统已经启动过并且成功写入过配置，修改此环境变量将不再起作用。
# 运行时真实值来源是 ConfigStore.policy，请务必使用 API 或 Bot 进行动态修改。
# 设置为 [1] 表示首次启动时仅同步收藏夹 (默认)
# 设置为 [] 表示首次启动时允许所有消息 (不推荐，数据量很大)
# 示例: [-1001234567890, -1009876543210, 123456789]
WHITE_LIST=[1]

# ⚠️ 警告：策略服务冷启动默认值 (BLACK_LIST)
# 仅在首次启动时有效，原因同上。
# 运行时真实值来自 ConfigStore.policy，优先级高于白名单：即使在白名单中，黑名单 ID 也会被拒绝
# 示例: [-1001111111111, -1002222222222]
BLACK_LIST=[]

# 运行时策略刷新间隔（秒）
# Telegram 监听器每 N 秒从 ConfigPolicyService 刷新一次白/黑名单
POLICY_REFRESH_TTL_SEC=10

# 统一可观测性快照采集超时（秒）
# 用于 /status、/search/stats、/storage/stats、Bot /ping 等统一状态采集
OBS_SNAPSHOT_TIMEOUT_SEC=0.8

# 统一可观测性慢采集告警阈值（毫秒）
# 当任一快照采集耗时 > 该阈值时会记录 WARNING 日志
OBS_SNAPSHOT_WARN_MS=800

# Bot 管理员 ID - 只有这些用户可以使用 Bot 的搜索功能
# 设置为空列表 [] 表示允许所有用户使用
# 示例: [123456789, 987654321]
OWNER_IDS=[]


# ==============================================================================
# 登录设置 (可选)
# ==============================================================================

# Telethon 会话字符串 (用于无头登录，如 Docker/CI 环境)
# 如果设置，将使用此字符串登录而不是文件会话
# 可通过运行 python -m telethon 生成会话字符串
# SESSION_STRING=


# ==============================================================================
# REST API 设置 (可选)
# ==============================================================================



# API Key - 用于保护 REST API 端点的认证密钥
# 如果不设置，API 将不需要认证 (不推荐在生产环境使用)
# 建议生成随机密钥: openssl rand -hex 32
# API_KEY=your-secure-api-key-here

# API Key 请求头名称 (默认: X-API-Key)
# 客户端需要在此头中传递 API Key
# API_KEY_HEADER=X-API-Key

# Bearer Token 持久化文件路径（默认: session/auth_tokens.json）
# 为空字符串表示仅内存存储（重启后失效）
# AUTH_TOKEN_STORE_FILE=session/auth_tokens.json

# API 鉴权流程使用的 Telethon 会话文件（默认: session/api_auth.session）
# 仅影响 /api/v1/auth/send-code 与 /api/v1/auth/signin 登录流程
# API_AUTH_SESSION_FILE=session/api_auth.session

# CORS 允许的来源（逗号分隔，用于 WebUI 跨域请求）
# 默认允许 Vite 开发服务器和常见本地端口
# CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# API 访问日志总开关（默认: true）
# false 时将不记录统一 access log（不影响业务日志）
# API_ACCESS_LOG_ENABLED=true

# API 慢请求告警阈值（毫秒，默认: 800）
# 超过阈值的请求会提升为 WARNING 级别日志
# API_ACCESS_LOG_SLOW_MS=800

# API 访问日志跳过路径（逗号分隔）
# 默认跳过健康检查与文档页面
# API_ACCESS_LOG_SKIP_PATHS=/health,/docs,/redoc,/openapi.json,/docs/oauth2-redirect

# API 请求链路追踪 header 名称（默认: X-Request-ID）
# 访问日志与响应头都将使用该字段，便于前后端关联排障
# API_REQUEST_ID_HEADER=X-Request-ID


# ==============================================================================
# 运行控制与启动模式 (可选)
# ==============================================================================

# 是否启用 API-only 模式（默认 false）
# true: 禁用 Telegram 运行任务启动（/api/v1/client/start 与 /start_client 会返回不可启动语义）
# false: 允许通过 API 或 Bot 启动统一运行任务
# API_ONLY=false

# 是否禁用 Bot 自动后台启动（默认 false）
# true: 启动 API 时不自动拉起 Bot，可通过 /api/v1/client/start 手动启动
# false: 在非 API-only 且非 pytest 场景自动启动 Bot
# DISABLE_BOT_AUTOSTART=false

# 是否跳过配置校验（默认 false）
# 仅用于开发/测试环境，生产环境不建议开启
# SKIP_CONFIG_VALIDATION=false

# 是否启用 tracemalloc（默认 true）
# 关闭后 /status 的内存统计回退为平台资源统计
# ENABLE_TRACEMALLOC=true

# 仅用于集成测试：允许 /api/v1/auth/dev/issue-token 端点（默认关闭）
# 生产环境请保持关闭
# ALLOW_TEST_TOKEN_ISSUE=false


# ==============================================================================
# 网络设置 (可选)
# ==============================================================================

# 是否使用 IPv6 连接 Telegram (默认: False)
IPv6=False

# 代理设置 (格式见 Telethon 文档)
# SOCKS5 示例: socks5://127.0.0.1:1080
# HTTP 示例: http://127.0.0.1:8080
# 带认证: socks5://user:pass@127.0.0.1:1080
# PROXY=


# ==============================================================================
# 日志设置 (可选)
# ==============================================================================

# 控制台日志级别 (数字)
# 10 = DEBUG (调试信息，非常详细)
# 20 = INFO (一般信息)
# 25 = NOTICE (注意事项，默认)
# 30 = WARNING (警告)
# 40 = ERROR (错误)
LOGGING_LEVEL=25

# 文件日志级别 (写入 log_file.log)
# 建议设置为 WARNING(30) 或更高，避免日志文件过大
LOGGING2FILE_LEVEL=30


# ==============================================================================
# 性能控制 (可选)
# ==============================================================================

# 每次批量上传到 MeiliSearch 的消息数量 (默认: 200)
# 较大的值可能提高导入效率，但会增加内存使用
# 如果遇到 Telegram 限流，可以减小此值
BATCH_MSG_UNM=200


# ==============================================================================
# 消息记录设置 (可选)
# ==============================================================================

# 是否不记录消息编辑历史 (默认: True)
# True: 消息编辑后只保留最新版本
# False: 保留消息编辑历史 (会增加存储空间)
NOT_RECORD_MSG=True


# ==============================================================================
# 搜索设置 (可选)
# ==============================================================================

# 是否开启搜索结果缓存 (默认: True)
# 开启后可减少重复查询对 MeiliSearch 的请求
SEARCH_CACHE=True

# 缓存过期时间 (秒，默认: 7200 = 2小时)
CACHE_EXPIRE_SECONDS=7200

# 搜索分页 - 最大页数 (默认: 10)
# 设置过大可能导致内存占用增加
MAX_PAGE=10

# 搜索分页 - 每页显示的消息数量 (默认: 5)
# 设置过大可能导致 Telegram 发送失败 (消息长度限制)
RESULTS_PER_PAGE=5

# SearchService 展示层预取上限 (默认: MAX_PAGE * RESULTS_PER_PAGE = 50)
# Bot/API 统一分页时会先预取此数量窗口，再切分页返回
SEARCH_PRESENTATION_MAX_HITS=50

# SearchService 分页短 token TTL (秒，默认: 与 CACHE_EXPIRE_SECONDS 一致)
# 当 callback 数据超过 Telegram 64 bytes 限制时，自动使用短 token
SEARCH_CALLBACK_TOKEN_TTL_SEC=7200


# ==============================================================================
# 时区设置 (可选)
# ==============================================================================

# 时区 - 控制 MeiliSearch 中消息的时间显示
# 使用 IANA 时区名称: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
# 常用值:
#   Asia/Shanghai     - 中国 (UTC+8)
#   Asia/Tokyo        - 日本 (UTC+9)
#   Asia/Seoul        - 韩国 (UTC+9)
#   Europe/London     - 英国 (UTC+0/+1)
#   America/New_York  - 美国东部 (UTC-5/-4)
TIME_ZONE=Asia/Shanghai


# ==============================================================================
# 表情反应权重 (高级配置, 可选)
# ==============================================================================

# Telegram 表情反应的情感分数权重
# 用于计算消息的 reactions_scores 字段，影响搜索排序
# 格式: Python 字典 {"emoji": score, ...}
# 正值 = 正面情感, 负值 = 负面情感, 0 = 中性
#
# 默认配置:
# TELEGRAM_REACTIONS={"👍": 1.0, "❤️": 1.5, "🔥": 1.4, "🎉": 1.3, "🤩": 1.4, "👏": 1.2, "♥️": 1.5, "🥰": 1.5, "🤔": 0.0, "🤯": 0.0, "👎": -1.0, "😱": -0.5, "😢": -0.8, "🤬": -1.2, "💩": -1.5}


# ==============================================================================
# MeiliSearch 索引配置 (高级配置, 可选)
# ==============================================================================

# MeiliSearch 索引配置
# 通常不需要修改，除非你需要自定义搜索行为
# 格式: Python 字典
#
# 默认配置包含:
# - searchableAttributes: ["text", "id"]
# - filterableAttributes: ["chat.type", "date", "from_user", "reactions_scores"]
# - sortableAttributes: ["date", "id"]
# - rankingRules: 按相关性、日期、反应分数排序
#
# INDEX_CONFIG={"displayedAttributes": ["*"], "searchableAttributes": ["text", "id"], ...}


# ==============================================================================
# Docker 特定配置 (仅在 Docker 环境中使用)
# ==============================================================================

# 如果在 Docker 中运行，MeiliSearch 使用服务名
# MEILI_HOST=http://meilisearch:7700
